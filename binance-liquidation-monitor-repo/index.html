
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Binance Liquidation Monitor — Lite Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); }
    .dark .glass { background: rgba(15,23,42,0.6); }
    .card { border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .badge { border-radius: 9999px; padding: .25rem .6rem; font-size: .75rem; }
    .skeleton { animation: pulse 1.5s ease-in-out infinite; background: rgba(148,163,184,.25); }
    @keyframes pulse {
      0% { opacity: 1 }
      50% { opacity: .4 }
      100% { opacity: 1 }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50 to-purple-100 text-slate-800">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center shadow-lg">
          <i data-lucide="zap" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold">Binance Liquidation Monitor</h1>
          <p class="text-sm text-slate-500">Real‑time liquidations + AI context (lite)</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="envBadge" class="badge bg-slate-800 text-white hidden">Mock Mode</span>
        <button id="refreshBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh
        </button>
        <button id="toggleTheme" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-200 text-slate-700 hover:bg-slate-300 transition">
          <i data-lucide="moon" class="w-4 h-4"></i>
        </button>
      </div>
    </header>

    <!-- Top Stats -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
      <div class="card p-5 bg-white glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">Uptime</span>
          <i data-lucide="activity" class="w-4 h-4 text-indigo-600"></i>
        </div>
        <div id="uptime" class="mt-2 text-2xl font-semibold">—</div>
        <div class="text-slate-400 text-xs mt-1">system uptime</div>
      </div>
      <div class="card p-5 bg-white glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">Processed Today</span>
          <i data-lucide="cpu" class="w-4 h-4 text-indigo-600"></i>
        </div>
        <div id="processed" class="mt-2 text-2xl font-semibold">—</div>
        <div class="text-slate-400 text-xs mt-1">events</div>
      </div>
      <div class="card p-5 bg-white glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">AI Confidence</span>
          <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
        </div>
        <div id="aiAccuracy" class="mt-2 text-2xl font-semibold">—%</div>
        <div class="w-full bg-slate-200 h-2 rounded mt-3">
          <div id="aiBar" class="h-2 rounded bg-indigo-500" style="width:0%"></div>
        </div>
      </div>
      <div class="card p-5 bg-white glass">
        <div class="flex items-center justify-between">
          <span class="text-slate-500 text-sm">Telegram Delivery</span>
          <i data-lucide="send" class="w-4 h-4 text-indigo-600"></i>
        </div>
        <div id="tgDelivery" class="mt-2 text-2xl font-semibold">—%</div>
        <div class="text-slate-400 text-xs mt-1">last 24h</div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="mt-8">
      <div class="flex gap-2">
        <button data-tab="liqs" class="tabBtn px-4 py-2 rounded-xl bg-indigo-600 text-white">Liquidations</button>
        <button data-tab="symbols" class="tabBtn px-4 py-2 rounded-xl bg-white text-slate-700">Symbols</button>
        <button data-tab="status" class="tabBtn px-4 py-2 rounded-xl bg-white text-slate-700">Status</button>
        <div class="ml-auto text-sm text-slate-500 flex items-center gap-2">
          <i data-lucide="link" class="w-4 h-4"></i>
          <span>API Base: <code id="apiBaseText" class="text-indigo-700">/api</code></span>
        </div>
      </div>

      <!-- Content -->
      <div class="mt-4">
        <!-- Liquidations -->
        <div id="tab-liqs" class="card bg-white glass p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Recent Liquidations</h2>
            <div class="text-sm text-slate-500" id="liqsCount">—</div>
          </div>
          <div id="liqsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <!-- items injected -->
          </div>
        </div>

        <!-- Symbols -->
        <div id="tab-symbols" class="card bg-white glass p-4 hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Monitored Symbols</h2>
            <div class="text-sm text-slate-500" id="symLast">—</div>
          </div>
          <div id="symbolsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Status -->
        <div id="tab-status" class="card bg-white glass p-4 hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">System Status</h2>
            <span id="statusBadge" class="badge bg-slate-800 text-white">—</span>
          </div>
          <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
            <div><dt class="text-slate-500 text-sm">Uptime</dt><dd id="stUptime" class="font-medium">—</dd></div>
            <div><dt class="text-slate-500 text-sm">Processed Today</dt><dd id="stProcessed" class="font-medium">—</dd></div>
            <div><dt class="text-slate-500 text-sm">Total Liquidations</dt><dd id="stTotal" class="font-medium">—</dd></div>
            <div><dt class="text-slate-500 text-sm">Avg. Latency</dt><dd id="stLatency" class="font-medium">—</dd></div>
            <div><dt class="text-slate-500 text-sm">Last Update</dt><dd id="stLast" class="font-medium">—</dd></div>
          </dl>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-10 text-center text-xs text-slate-500">
      <p>Tip: set a custom API base with <code>?apiBase=http://localhost:8080</code>. Auto-refresh ~30s.</p>
    </footer>
  </div>

  <script>
    // --- Utilities
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const params = new URLSearchParams(location.search);
    const apiBase = params.get('apiBase') || '/api';
    qs('#apiBaseText').textContent = apiBase;

    const fmtPct = (n)=> (n==null? '—' : (typeof n==='number'? n.toFixed(1)+'%': n));
    const fmtNum = (n)=> (n==null? '—' : new Intl.NumberFormat().format(n));
    const fmtTime = (s)=> s || '—';
    const sleep = (ms)=> new Promise(res=>setTimeout(res, ms));

    // Theme toggle
    const toggle = qs('#toggleTheme');
    toggle.addEventListener('click',()=>{
      document.documentElement.classList.toggle('dark');
      document.body.classList.toggle('bg-slate-900');
      document.body.classList.toggle('text-slate-100');
    });

    // Tabs
    qsa('.tabBtn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        qsa('.tabBtn').forEach(b=>{ b.classList.remove('bg-indigo-600','text-white'); b.classList.add('bg-white','text-slate-700'); });
        btn.classList.add('bg-indigo-600','text-white'); btn.classList.remove('bg-white','text-slate-700');
        const target = btn.dataset.tab;
        ['liqs','symbols','status'].forEach(t=> qs('#tab-'+t).classList.add('hidden'));
        qs('#tab-'+target).classList.remove('hidden');
      });
    });

    // Data fetching with graceful fallback
    let useMock = false;
    const setMockBadge = (on)=>{
      const el = qs('#envBadge');
      if(on){ el.classList.remove('hidden') } else { el.classList.add('hidden') }
    };

    const tryFetch = async (path)=>{
      try{
        const r = await fetch(apiBase + path, {headers: {'Accept':'application/json'}});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        return data.data || data; // tolerate both shapes
      }catch(e){
        useMock = true;
        setMockBadge(true);
        console.warn('Falling back to mock for', path, e);
        return null;
      }
    };

    const mockStatus = {
      status: 'running',
      uptime: '1d 03h 22m',
      processed_today: 482,
      ai_accuracy: 82,
      telegram_delivery: 99.1,
      avg_latency: '1.7s',
      total_liquidations: 1203,
      last_update: new Date().toISOString()
    };

    const mockLiqs = [
      {id:1, symbol:'XRPUSDT', side:'SELL', price:0.5234, quantity:15000, timestamp:new Date(Date.now()-60000).toISOString(), ai_recommendation:'BUY', confidence:78, risk_level:'MEDIUM'},
      {id:2, symbol:'DOGEUSDT', side:'BUY', price:0.118, quantity:32000, timestamp:new Date(Date.now()-120000).toISOString(), ai_recommendation:'HOLD', confidence:61, risk_level:'LOW'},
      {id:3, symbol:'PEPEUSDT', side:'SELL', price:0.0000071, quantity:120000000, timestamp:new Date(Date.now()-220000).toISOString(), ai_recommendation:'SELL', confidence:72, risk_level:'HIGH'}
    ];

    const mockSymbols = [
      {symbol:'XRPUSDT', status:'active', websocket_status:'connected', last_event:new Date().toISOString(), today_count:89},
      {symbol:'DOGEUSDT', status:'active', websocket_status:'connected', last_event:new Date().toISOString(), today_count:75},
      {symbol:'PEPEUSDT', status:'active', websocket_status:'connected', last_event:new Date().toISOString(), today_count:56},
    ];

    // Render helpers
    const renderStatus = (st)=>{
      qs('#uptime').textContent = fmtTime(st.uptime);
      qs('#processed').textContent = fmtNum(st.processed_today);
      qs('#aiAccuracy').textContent = fmtPct(st.ai_accuracy);
      qs('#aiBar').style.width = (st.ai_accuracy||0)+'%';
      qs('#tgDelivery').textContent = fmtPct(st.telegram_delivery);

      qs('#statusBadge').textContent = st.status || '—';
      qs('#stUptime').textContent = fmtTime(st.uptime);
      qs('#stProcessed').textContent = fmtNum(st.processed_today);
      qs('#stTotal').textContent = fmtNum(st.total_liquidations);
      qs('#stLatency').textContent = st.avg_latency || '—';
      qs('#stLast').textContent = st.last_update ? new Date(st.last_update).toLocaleString() : '—';
    };

    const pill = (txt, tone)=>{
      const tones = {
        buy: 'bg-emerald-100 text-emerald-700',
        sell: 'bg-rose-100 text-rose-700',
        hold: 'bg-amber-100 text-amber-700',
        wait: 'bg-slate-200 text-slate-700',
      };
      return `<span class="badge ${tones[tone]||'bg-slate-200 text-slate-700'}">${txt}</span>`;
    };

    const renderLiqs = (arr)=>{
      const wrap = qs('#liqsList'); wrap.innerHTML = '';
      qs('#liqsCount').textContent = `${arr.length} items`;
      arr.forEach(e=>{
        const rec = (e.ai_recommendation||'').toUpperCase();
        const tone = rec==='BUY'?'buy':(rec==='SELL'?'sell':(rec==='HOLD'?'hold':'wait'));
        const item = document.createElement('div');
        item.className = 'card bg-white p-4 border border-slate-100';
        item.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${e.symbol}</div>
            ${pill(rec || '—', tone)}
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div class="text-slate-500">Side</div><div class="font-medium">${e.side||'—'}</div>
            <div class="text-slate-500">Price</div><div class="font-medium">${e.price ?? '—'}</div>
            <div class="text-slate-500">Qty</div><div class="font-medium">${fmtNum(e.quantity)}</div>
            <div class="text-slate-500">Confidence</div><div class="font-medium">${e.confidence!=null? e.confidence+'%':'—'}</div>
            <div class="text-slate-500">Risk</div><div class="font-medium">${e.risk_level||'—'}</div>
            <div class="text-slate-500">Time</div><div class="font-medium">${e.timestamp? new Date(e.timestamp).toLocaleString(): '—'}</div>
          </div>
        `;
        wrap.appendChild(item);
      });
    };

    const renderSymbols = (arr)=>{
      const wrap = qs('#symbolsList'); wrap.innerHTML = '';
      qs('#symLast').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      arr.forEach(s=>{
        const badge = s.websocket_status==='connected' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
        const el = document.createElement('div');
        el.className = 'card bg-white p-4 border border-slate-100';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${s.symbol}</div>
            <span class="badge ${badge}">${s.websocket_status||'unknown'}</span>
          </div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div class="text-slate-500">Status</div><div class="font-medium">${s.status||'—'}</div>
            <div class="text-slate-500">Today Count</div><div class="font-medium">${fmtNum(s.today_count)}</div>
            <div class="text-slate-500">Last Event</div><div class="font-medium">${s.last_event? new Date(s.last_event).toLocaleString(): '—'}</div>
          </div>
        `;
        wrap.appendChild(el);
      });
    };

    // Load icons
    lucide.createIcons();

    // Refresh logic
    const loadAll = async ()=>{
      useMock = false; setMockBadge(false);
      let st = await tryFetch('/status'); if(!st) st = mockStatus;
      renderStatus(st);

      let liqs = await tryFetch('/liquidations'); if(!liqs) liqs = mockLiqs;
      renderLiqs(liqs);

      let syms = await tryFetch('/symbols'); if(!syms) syms = mockSymbols;
      renderSymbols(syms);
    };

    // Attach refresh
    qs('#refreshBtn').addEventListener('click', loadAll);

    // Initial + auto
    loadAll();
    setInterval(loadAll, 30000);
  </script>
</body>
</html>
